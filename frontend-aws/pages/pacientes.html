<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Pacientes - DSIM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <script src="../js/api-config-cors.js"></script>
    <style>
        /* Estilos espec√≠ficos da p√°gina de pacientes */
        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-xl);
        }
        
        .patient-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-xl);
            transition: var(--transition-normal);
            border: 1px solid #e5e7eb;
        }
        
        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .patient-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .patient-info {
            margin-left: var(--spacing-md);
        }
        
        .patient-info h3 {
            color: var(--black);
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .patient-info p {
            color: var(--secondary-gray);
            font-size: 0.875rem;
        }
        
        .patient-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            align-items: center;
        }
        
        .patient-actions .btn {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1rem;
            min-width: unset;
            flex: none;
        }
        
        .patient-actions .btn i {
            margin: 0;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-heartbeat"></i> DSIM
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="fas fa-home"></i> In√≠cio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="pacientes.html">
                            <i class="fas fa-users"></i> Pacientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="adicionar-paciente.html">
                            <i class="fas fa-user-plus"></i> Adicionar Paciente
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="usuarios.html">
                            <i class="fas fa-user-cog"></i> Usu√°rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="configurar-alertas.html">
                            <i class="fas fa-bell-slash"></i> Configurar Alertas
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="userName">Usu√°rio</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title">Dashboard de Monitoramento</h2>
            <p class="page-subtitle">Acompanhe os sinais vitais e status de todos os pacientes em tempo real</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-users stat-icon"></i>
                <div class="stat-number" id="totalPatients">8</div>
                <div class="stat-label">Total de Pacientes</div>
            </div>
            <div class="stat-card success">
                <i class="fas fa-heart stat-icon"></i>
                <div class="stat-number" id="stablePatients">6</div>
                <div class="stat-label">Sinais Est√°veis</div>
            </div>
            <div class="stat-card warning">
                <i class="fas fa-exclamation-triangle stat-icon"></i>
                <div class="stat-number" id="warningPatients">1</div>
                <div class="stat-label">Aten√ß√£o Necess√°ria</div>
            </div>
            <div class="stat-card danger">
                <i class="fas fa-bell stat-icon"></i>
                <div class="stat-number" id="criticalPatients">1</div>
                <div class="stat-label">Estado Cr√≠tico</div>
            </div>
        </div>

        <!-- Patients Grid -->
        <div class="patients-grid" id="patientsGrid">
            <!-- Os pacientes ser√£o inseridos aqui via JavaScript -->
        </div>
    </main>



    <!-- Modal de Editar Paciente -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Editar Paciente</h2>
                <span class="modal-close" onclick="closeModal('editModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editPatientForm">
                    <div class="form-section">
                        <h3>Informa√ß√µes Pessoais</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome Completo *</label>
                                <input type="text" id="editName" name="name" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Data de Nascimento *</label>
                                <input type="date" id="editBirthdate" name="birthdate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">G√™nero *</label>
                                <select id="editGender" name="gender" class="form-select" required>
                                    <option value="">Selecione</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="feminino">Feminino</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Telefone</label>
                                <input type="tel" id="editPhone" name="phone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado Civil</label>
                                <select id="editRelationship" name="relationship" class="form-select">
                                    <option value="">Selecione</option>
                                    <option value="solteiro">Solteiro(a)</option>
                                    <option value="casado">Casado(a)</option>
                                    <option value="divorciado">Divorciado(a)</option>
                                    <option value="viuvo">Vi√∫vo(a)</option>
                                    <option value="uniao_estavel">Uni√£o Est√°vel</option>
                                    <option value="separado">Separado(a)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Quarto/Leito</label>
                                <input type="text" id="editRoom" name="room" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Informa√ß√µes M√©dicas</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Tipo Sangu√≠neo</label>
                                <select id="editBloodType" name="bloodType" class="form-select">
                                    <option value="">Selecione</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alergias</label>
                                <input type="text" id="editAllergies" name="allergies" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Defici√™ncia/Necessidades Especiais</label>
                                <textarea id="editDeficiencia" name="deficiencia" class="form-input" rows="2" placeholder="Descreva as defici√™ncias ou necessidades especiais"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Condi√ß√µes M√©dicas</label>
                            <textarea id="editMedicalConditions" name="medicalConditions" class="form-textarea"></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Contato de Emerg√™ncia</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome do Contato</label>
                                <input type="text" id="editEmergencyName" name="emergencyName" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parentesco</label>
                                <select id="editParentesco" name="parentesco" class="form-select">
                                    <option value="">Selecione o parentesco</option>
                                    <option value="pai">Pai</option>
                                    <option value="mae">M√£e</option>
                                    <option value="filho">Filho(a)</option>
                                    <option value="conjuge">C√¥njuge</option>
                                    <option value="irmao">Irm√£o(√£)</option>
                                    <option value="av√¥">Av√¥(√≥)</option>
                                    <option value="tio">Tio(a)</option>
                                    <option value="primo">Primo(a)</option>
                                    <option value="amigo">Amigo(a)</option>
                                    <option value="vizinho">Vizinho(a)</option>
                                    <option value="cuidador">Cuidador(a)</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Telefone de Emerg√™ncia</label>
                                <input type="tel" id="editEmergencyPhone" name="emergencyPhone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email de Emerg√™ncia</label>
                                <input type="email" id="editEmergencyEmail" name="emergencyEmail" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('editModal')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn-secondary" onclick="window.location.href='../index.html'">
                            <i class="fas fa-home"></i> Sair
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Salvar Altera√ß√µes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Vari√°vel para armazenar os pacientes carregados do backend
    let patients = [];
    let alertConfigs = {};

        // Fun√ß√£o para buscar configura√ß√µes de alerta do backend
        async function carregarAlertConfigs() {
            try {
                const configs = await apiRequest('/api/configuracao-alertas', { method: 'GET' });
                // Organizar por tipo de sinal
                alertConfigs = {};
                if (Array.isArray(configs)) {
                    configs.forEach(cfg => {
                        if (cfg.tipoSinal) {
                            alertConfigs[cfg.tipoSinal] = {
                                min: cfg.valorMinimo,
                                max: cfg.valorMaximo
                            };
                        }
                    });
                }
                console.log('Limites de alerta carregados:', alertConfigs);
            } catch (error) {
                console.error('Erro ao carregar limites de alerta:', error);
                alertConfigs = {};
            }
        }

        // Fun√ß√£o para buscar pacientes do backend
        async function carregarPacientes() {
            try {
                // Obter usu√°rio logado do localStorage (corrigido)
                const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));
                if (!usuarioLogado || !usuarioLogado.email) {
                    console.error('Usu√°rio n√£o encontrado. Redirecionando para login...');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('üîç Carregando pacientes para:', usuarioLogado.email);

                // Filtrar pacientes por usu√°rio logado
                const pacientesData = await apiRequest(`/api/pacientes?usuarioEmail=${encodeURIComponent(usuarioLogado.email)}`, {
                    method: 'GET',
                    headers: {
                        'X-Usuario-Email': usuarioLogado.email
                    }
                });
                
                if (pacientesData && Array.isArray(pacientesData)) {
                    patients = pacientesData.map(paciente => {
                        const idade = calcularIdade(paciente.dataNascimento);
                        const sinais = paciente.sinaisVitais || {};
                        return {
                            id: paciente.id,
                            name: paciente.nome,
                            age: idade,
                            room: (paciente.informacaoMedica && paciente.informacaoMedica.quarto) || paciente.quarto || 'N/A',
                            heartRate: sinais.batimentos || 0,
                            oxygen: sinais.oxigenio || 0,
                            temperature: sinais.temperatura || 0,
                            status: determinarStatusComAlertas(sinais)
                        };
                    });
                    console.log('Pacientes carregados:', patients);
                } else {
                    console.error('Erro ao carregar pacientes');
                    patients = [];
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                patients = [];
            }
        }

        // Fun√ß√£o para calcular idade a partir da data de nascimento
        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return 'N/A';
            const hoje = new Date();
            const nascimento = new Date(dataNascimento);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mes = hoje.getMonth() - nascimento.getMonth();
            if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                idade--;
            }
            return idade;
        }

        // Fun√ß√£o para formatar estado civil
        function formatarEstadoCivil(relacionamento) {
            if (!relacionamento) return 'N/A';
            
            const estados = {
                'solteiro': 'Solteiro(a)',
                'casado': 'Casado(a)', 
                'divorciado': 'Divorciado(a)',
                'viuvo': 'Vi√∫vo(a)',
                'uniao_estavel': 'Uni√£o Est√°vel',
                'separado': 'Separado(a)'
            };
            
            return estados[relacionamento] || relacionamento;
        }

        // Fun√ß√£o para determinar status baseado nos sinais vitais e limites de alerta
        function determinarStatusComAlertas(sinais) {
            // Se n√£o houver limites, usar padr√£o antigo
            if (!alertConfigs || Object.keys(alertConfigs).length === 0) {
                // ...existing code...
                if (!sinais.oxigenio || !sinais.temperatura || !sinais.batimentos) {
                    return 'normal';
                }
                if (sinais.oxigenio < 90 || sinais.temperatura > 38.5 || sinais.batimentos > 120 || sinais.batimentos < 50) {
                    return 'critical';
                }
                if (sinais.oxigenio < 95 || sinais.temperatura > 37.5 || sinais.batimentos > 100 || sinais.batimentos < 60) {
                    return 'warning';
                }
                return 'normal';
            }

            // Usar limites reais
            // Para cada sinal, verifica limites
            let status = 'normal';
            // Oxig√™nio
            if (alertConfigs.oxigenio) {
                const min = alertConfigs.oxigenio.min;
                const max = alertConfigs.oxigenio.max;
                if (sinais.oxigenio < min || sinais.oxigenio > max) {
                    return 'critical';
                } else if (sinais.oxigenio < min + ((max-min)*0.1) || sinais.oxigenio > max - ((max-min)*0.1)) {
                    status = 'warning';
                }
            }
            // Temperatura
            if (alertConfigs.temperatura) {
                const min = alertConfigs.temperatura.min;
                const max = alertConfigs.temperatura.max;
                if (sinais.temperatura < min || sinais.temperatura > max) {
                    return 'critical';
                } else if (sinais.temperatura < min + ((max-min)*0.1) || sinais.temperatura > max - ((max-min)*0.1)) {
                    status = 'warning';
                }
            }
            // Batimentos
            if (alertConfigs.batimentos) {
                const min = alertConfigs.batimentos.min;
                const max = alertConfigs.batimentos.max;
                if (sinais.batimentos < min || sinais.batimentos > max) {
                    return 'critical';
                } else if (sinais.batimentos < min + ((max-min)*0.1) || sinais.batimentos > max - ((max-min)*0.1)) {
                    status = 'warning';
                }
            }
            return status;
        }



        // Fun√ß√£o para obter classe do status
        function getStatusClass(status) {
            switch(status) {
                case 'critical': return 'danger';
                case 'warning': return 'warning';
                default: return 'normal';
            }
        }

        // Fun√ß√£o para obter iniciais do nome
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        // Fun√ß√£o para renderizar pacientes
        function renderPatients() {
            const grid = document.getElementById('patientsGrid');
            
            grid.innerHTML = patients.map(patient => `
                <div class="patient-card">
                    <div class="patient-header">
                        <div class="patient-avatar">
                            ${getInitials(patient.name)}
                        </div>
                        <div class="patient-info">
                            <h3>${patient.name}</h3>
                            <p>${patient.age} anos ‚Ä¢ ${patient.room !== 'N/A' ? patient.room : 'Estado civil n√£o informado'}</p>
                        </div>
                    </div>
                    
                    <div class="vitals-grid">
                        <div class="vital-item">
                            <div class="vital-icon ${getStatusClass(patient.status)}">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="vital-value">${patient.heartRate}</div>
                            <div class="vital-label">BPM</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-icon ${patient.oxygen < 95 ? 'danger' : 'normal'}">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <div class="vital-value">${patient.oxygen}%</div>
                            <div class="vital-label">SpO‚ÇÇ</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-icon ${patient.temperature > 37.5 ? 'danger' : 'normal'}">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="vital-value">${patient.temperature}¬∞C</div>
                            <div class="vital-label">Temp</div>
                        </div>
                    </div>
                    
                    <div class="patient-actions">
                        <button class="btn btn-primary" onclick="viewPatient(${patient.id})" title="Ver Detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="editPatient(${patient.id})" title="Editar Paciente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deletePatient(${patient.id})" title="Excluir Paciente">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Fun√ß√µes de a√ß√£o
        function addPatient() {
            alert('Funcionalidade de adicionar paciente ser√° implementada.');
        }

        // Vari√°vel para armazenar o ID do paciente sendo editado
        let currentPatientId = null;

        // Fun√ß√£o para abrir modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Fun√ß√£o para fechar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentPatientId = null;
        }

        // Fechar modal clicando fora dele
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    currentPatientId = null;
                }
            });
        }

        // Fun√ß√£o para buscar dados completos do paciente do backend
        async function buscarPacienteCompleto(id) {
            try {
                const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));
                const data = await apiRequest(`/api/pacientes/${id}`, {
                    method: 'GET',
                    headers: {
                        'X-Usuario-Email': usuarioLogado.email
                    }
                });
                if (data) {
                    return data;
                }
            } catch (error) {
                console.error('Erro ao buscar paciente:', error);
            }
            return null;
        }

        // Fun√ß√£o para ver detalhes do paciente
        function viewPatient(id) {
            // Redirecionar para a p√°gina de detalhes com o ID do paciente
            window.location.href = `detalhes-paciente.html?id=${id}`;
        }

        // Fun√ß√£o para editar paciente
        async function editPatient(id) {
            const paciente = await buscarPacienteCompleto(id);
            if (!paciente) {
                alert('Erro ao carregar dados do paciente');
                return;
            }

            currentPatientId = id;
            const contato = paciente.contatoEmergencial || {};

            // Preencher formul√°rio de edi√ß√£o com dados corretos do mock
            document.getElementById('editName').value = paciente.nome || '';
            document.getElementById('editBirthdate').value = paciente.dataNascimento || '';
            document.getElementById('editGender').value = paciente.genero || '';
            document.getElementById('editPhone').value = paciente.telefone || '';
            document.getElementById('editRelationship').value = contato.parentesco || '';
            document.getElementById('editRoom').value = paciente.quarto || '';
            const infoMed = paciente.informacaoMedica || {};
            document.getElementById('editBloodType').value = infoMed.tipoSangue || '';
            document.getElementById('editAllergies').value = infoMed.problemasEspecificos || '';
            document.getElementById('editMedicalConditions').value = infoMed.deficiencia || '';
            document.getElementById('editEmergencyName').value = contato.nome || '';
            document.getElementById('editParentesco').value = contato.parentesco || '';
            document.getElementById('editEmergencyPhone').value = contato.telefone || '';
            document.getElementById('editEmergencyPhone').value = contato.telefone || '';
            document.getElementById('editEmergencyEmail').value = contato.email || '';

            openModal('editModal');
        }

        // Fun√ß√£o para excluir paciente
        async function deletePatient(id) {
            const paciente = patients.find(p => p.id === id);
            if (!paciente) {
                alert('Paciente n√£o encontrado');
                return;
            }

            const confirmacao = confirm(
                `Tem certeza que deseja EXCLUIR PERMANENTEMENTE o paciente "${paciente.name}"?\n\n` +
                `Esta a√ß√£o n√£o pode ser desfeita e remover√° todos os dados do paciente, incluindo:\n` +
                `- Informa√ß√µes pessoais e m√©dicas\n` +
                `- Hist√≥rico de sinais vitais\n` +
                `- Alertas relacionados\n\n` +
                `Digite "CONFIRMAR" no pr√≥ximo campo se deseja prosseguir.`
            );

            if (!confirmacao) {
                return;
            }

            const confirmacaoTexto = prompt(
                `Para confirmar a exclus√£o do paciente "${paciente.name}", digite: CONFIRMAR`
            );

            if (confirmacaoTexto !== 'CONFIRMAR') {
                alert('Exclus√£o cancelada. Texto de confirma√ß√£o incorreto.');
                return;
            }

            console.log('üóëÔ∏è Excluindo paciente ID:', id);

            try {
                const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));
                if (!usuarioLogado || !usuarioLogado.email) {
                    alert('Erro: Usu√°rio n√£o autenticado');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await apiRequest(`/api/pacientes/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Usuario-Email': usuarioLogado.email,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('‚úÖ Paciente exclu√≠do:', response);

                alert('Paciente exclu√≠do com sucesso!');
                await carregarPacientes();
                renderPatients();
                updateStats();
            } catch (error) {
                console.error('‚ùå Erro ao excluir:', error);
                alert('Erro ao excluir paciente: ' + error.message);
            }
        }

        // Fun√ß√£o para salvar altera√ß√µes do paciente
        document.getElementById('editPatientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentPatientId) {
                alert('Erro: ID do paciente n√£o encontrado');
                return;
            }

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            const pacienteData = {
                nome: data.name.trim(),
                dataNascimento: data.birthdate,
                genero: data.gender,
                telefone: data.phone || null,
                relacionamento: data.relationship || null,
                contatoEmergencial: {
                    nome: data.emergencyName || null,
                    telefone: data.emergencyPhone || null,
                    email: data.emergencyEmail || null,
                    parentesco: data.parentesco || null,
                    instagram: null
                },
                informacaoMedica: {
                    tipoSangue: data.bloodType || null,
                    deficiencia: data.medicalConditions || null,
                    problemasEspecificos: data.allergies || null
                },
                sinaisVitais: {
                    oxigenio: parseFloat(data.oxygen) || 98.0,
                    temperatura: parseFloat(data.temperature) || 36.5,
                    batimentos: parseInt(data.heartRate) || 72,
                    statusOxigenio: 'normal',
                    statusTemperatura: 'normal',
                    statusBatimentos: 'normal'
                }
            };

            console.log('üì§ Enviando atualiza√ß√£o do paciente:', pacienteData);

            try {
                const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));
                if (!usuarioLogado || !usuarioLogado.email) {
                    alert('Erro: Usu√°rio n√£o autenticado');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await apiRequest(`/api/pacientes/${currentPatientId}`, {
                    method: 'PUT',
                    headers: {
                        'X-Usuario-Email': usuarioLogado.email,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pacienteData)
                });

                console.log('‚úÖ Resposta do servidor:', response);

                if (response && (response.id || response.success !== false)) {
                    closeModal('editModal');
                    await carregarPacientes();
                    renderPatients();
                    updateStats();
                    alert('Paciente atualizado com sucesso!');
                } else {
                    alert('Erro ao atualizar paciente: ' + (response.message || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar:', error);
                alert('Erro ao atualizar paciente: ' + error.message);
            }
        });

        // Atualizar estat√≠sticas
        function updateStats() {
            const total = patients.length;
            const stable = patients.filter(p => p.status === 'normal').length;
            const warning = patients.filter(p => p.status === 'warning').length;
            const critical = patients.filter(p => p.status === 'critical').length;
            
            document.getElementById('totalPatients').textContent = total;
            document.getElementById('stablePatients').textContent = stable;
            document.getElementById('warningPatients').textContent = warning;
            document.getElementById('criticalPatients').textContent = critical;
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar se usu√°rio est√° logado
            const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));
            if (!usuarioLogado || !usuarioLogado.email) {
                alert('Voc√™ precisa fazer login para acessar esta p√°gina.');
                window.location.href = 'login.html';
                return;
            }

            console.log('Usu√°rio logado:', usuarioLogado.nome, usuarioLogado.email);

            // Carregar limites de alerta e pacientes
            await carregarAlertConfigs();
            await carregarPacientes();
            renderPatients();
            updateStats();
            // Atualizar dados periodicamente
            setInterval(async () => {
                await carregarAlertConfigs();
                await carregarPacientes();
                renderPatients();
                updateStats();
            }, 30000); // Atualizar a cada 30 segundos
        });

        // Fun√ß√£o para exibir nome do usu√°rio no navbar
        function atualizarNavbar() {
            const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));
            if (usuarioLogado) {
                document.getElementById('userName').textContent = usuarioLogado.nome || 'Usu√°rio';
            }
        }

        // Fun√ß√£o de logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('usuario');
                window.location.href = 'login.html';
            }
        }

        // Atualizar navbar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            atualizarNavbar();
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>