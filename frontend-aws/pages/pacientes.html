<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Pacientes - DSIM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <script src="../js/api-config-cors.js"></script>
    <style>
        /* Estilos específicos da página de pacientes */
        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-xl);
        }
        
        .patient-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-xl);
            transition: var(--transition-normal);
            border: 1px solid #e5e7eb;
        }
        
        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .patient-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .patient-info {
            margin-left: var(--spacing-md);
        }
        
        .patient-info h3 {
            color: var(--black);
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .patient-info p {
            color: var(--secondary-gray);
            font-size: 0.875rem;
        }
        
        .patient-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            align-items: center;
        }
        
        .patient-actions .btn {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1rem;
            min-width: unset;
            flex: none;
        }
        
        .patient-actions .btn i {
            margin: 0;
        }
    </style>
</head>

<body>
    <!-- Navbar será inserido automaticamente pelo script -->

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title">Dashboard de Monitoramento</h2>
            <p class="page-subtitle">Acompanhe os sinais vitais e status de todos os pacientes em tempo real</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-users stat-icon"></i>
                <div class="stat-number" id="totalPatients">8</div>
                <div class="stat-label">Total de Pacientes</div>
            </div>
            <div class="stat-card success">
                <i class="fas fa-heart stat-icon"></i>
                <div class="stat-number" id="stablePatients">6</div>
                <div class="stat-label">Sinais Estáveis</div>
            </div>
            <div class="stat-card warning">
                <i class="fas fa-exclamation-triangle stat-icon"></i>
                <div class="stat-number" id="warningPatients">1</div>
                <div class="stat-label">Atenção Necessária</div>
            </div>
            <div class="stat-card danger">
                <i class="fas fa-bell stat-icon"></i>
                <div class="stat-number" id="criticalPatients">1</div>
                <div class="stat-label">Estado Crítico</div>
            </div>
        </div>

        <!-- Patients Grid -->
        <div class="patients-grid" id="patientsGrid">
            <!-- Os pacientes serão inseridos aqui via JavaScript -->
        </div>
    </main>



    <!-- Modal de Editar Paciente -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Editar Paciente</h2>
                <span class="modal-close" onclick="closeModal('editModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editPatientForm">
                    <div class="form-section">
                        <h3>Informações Pessoais</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome Completo *</label>
                                <input type="text" id="editName" name="name" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Data de Nascimento *</label>
                                <input type="date" id="editBirthdate" name="birthdate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gênero *</label>
                                <select id="editGender" name="gender" class="form-select" required>
                                    <option value="">Selecione</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="feminino">Feminino</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Telefone</label>
                                <input type="tel" id="editPhone" name="phone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado Civil</label>
                                <select id="editRelationship" name="relationship" class="form-select">
                                    <option value="">Selecione</option>
                                    <option value="solteiro">Solteiro(a)</option>
                                    <option value="casado">Casado(a)</option>
                                    <option value="divorciado">Divorciado(a)</option>
                                    <option value="viuvo">Viúvo(a)</option>
                                    <option value="uniao_estavel">União Estável</option>
                                    <option value="separado">Separado(a)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Quarto/Leito</label>
                                <input type="text" id="editRoom" name="room" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Informações Médicas</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Tipo Sanguíneo</label>
                                <select id="editBloodType" name="bloodType" class="form-select">
                                    <option value="">Selecione</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alergias</label>
                                <input type="text" id="editAllergies" name="allergies" class="form-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Condições Médicas</label>
                            <textarea id="editMedicalConditions" name="medicalConditions" class="form-textarea"></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Contato de Emergência</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome do Contato</label>
                                <input type="text" id="editEmergencyName" name="emergencyName" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefone de Emergência</label>
                                <input type="tel" id="editEmergencyPhone" name="emergencyPhone" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email de Emergência</label>
                                <input type="email" id="editEmergencyEmail" name="emergencyEmail" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('editModal')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Variável para armazenar os pacientes carregados do backend
        let patients = [];

        // Função para buscar pacientes do backend
        async function carregarPacientes() {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/pacientes`);
                if (response.ok) {
                    const pacientesData = await response.json();
                    
                    // Converter dados do backend para formato usado no frontend
                    patients = pacientesData.map(paciente => {
                        const idade = calcularIdade(paciente.dataNascimento);
                        const sinais = paciente.sinaisVitais || {};
                        
                        return {
                            id: paciente.id,
                            name: paciente.nome,
                            age: idade,
                            room: formatarEstadoCivil(paciente.relacionamento),
                            heartRate: sinais.batimentos || 0,
                            oxygen: sinais.oxigenio || 0,
                            temperature: sinais.temperatura || 0,
                            status: determinarStatus(sinais)
                        };
                    });
                    
                    console.log('Pacientes carregados:', patients);
                } else {
                    console.error('Erro ao carregar pacientes');
                    patients = [];
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                patients = [];
            }
        }

        // Função para calcular idade a partir da data de nascimento
        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return 'N/A';
            const hoje = new Date();
            const nascimento = new Date(dataNascimento);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mes = hoje.getMonth() - nascimento.getMonth();
            if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                idade--;
            }
            return idade;
        }

        // Função para formatar estado civil
        function formatarEstadoCivil(relacionamento) {
            if (!relacionamento) return 'N/A';
            
            const estados = {
                'solteiro': 'Solteiro(a)',
                'casado': 'Casado(a)', 
                'divorciado': 'Divorciado(a)',
                'viuvo': 'Viúvo(a)',
                'uniao_estavel': 'União Estável',
                'separado': 'Separado(a)'
            };
            
            return estados[relacionamento] || relacionamento;
        }

        // Função para determinar status baseado nos sinais vitais
        function determinarStatus(sinais) {
            if (!sinais.oxigenio || !sinais.temperatura || !sinais.batimentos) {
                return 'normal';
            }

            // Critérios para status crítico
            if (sinais.oxigenio < 90 || sinais.temperatura > 38.5 || sinais.batimentos > 120 || sinais.batimentos < 50) {
                return 'critical';
            }
            
            // Critérios para status de atenção
            if (sinais.oxigenio < 95 || sinais.temperatura > 37.5 || sinais.batimentos > 100 || sinais.batimentos < 60) {
                return 'warning';
            }
            
            return 'normal';
        }



        // Função para obter classe do status
        function getStatusClass(status) {
            switch(status) {
                case 'critical': return 'danger';
                case 'warning': return 'warning';
                default: return 'normal';
            }
        }

        // Função para obter iniciais do nome
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        // Função para renderizar pacientes
        function renderPatients() {
            const grid = document.getElementById('patientsGrid');
            
            grid.innerHTML = patients.map(patient => `
                <div class="patient-card">
                    <div class="patient-header">
                        <div class="patient-avatar">
                            ${getInitials(patient.name)}
                        </div>
                        <div class="patient-info">
                            <h3>${patient.name}</h3>
                            <p>${patient.age} anos • ${patient.room !== 'N/A' ? patient.room : 'Estado civil não informado'}</p>
                        </div>
                    </div>
                    
                    <div class="vitals-grid">
                        <div class="vital-item">
                            <div class="vital-icon ${getStatusClass(patient.status)}">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="vital-value">${patient.heartRate}</div>
                            <div class="vital-label">BPM</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-icon ${patient.oxygen < 95 ? 'danger' : 'normal'}">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <div class="vital-value">${patient.oxygen}%</div>
                            <div class="vital-label">SpO₂</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-icon ${patient.temperature > 37.5 ? 'danger' : 'normal'}">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="vital-value">${patient.temperature}°C</div>
                            <div class="vital-label">Temp</div>
                        </div>
                    </div>
                    
                    <div class="patient-actions">
                        <button class="btn btn-primary" onclick="viewPatient(${patient.id})" title="Ver Detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="editPatient(${patient.id})" title="Editar Paciente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deletePatient(${patient.id})" title="Excluir Paciente">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Funções de ação
        function addPatient() {
            alert('Funcionalidade de adicionar paciente será implementada.');
        }

        // Variável para armazenar o ID do paciente sendo editado
        let currentPatientId = null;

        // Função para abrir modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Função para fechar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentPatientId = null;
        }

        // Fechar modal clicando fora dele
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    currentPatientId = null;
                }
            });
        }

        // Função para buscar dados completos do paciente do backend
        async function buscarPacienteCompleto(id) {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/pacientes/${id}`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Erro ao buscar paciente:', error);
            }
            return null;
        }

        // Função para ver detalhes do paciente
        function viewPatient(id) {
            // Redirecionar para a página de detalhes com o ID do paciente
            window.location.href = `detalhes-paciente.html?id=${id}`;
        }

        // Função para editar paciente
        async function editPatient(id) {
            const paciente = await buscarPacienteCompleto(id);
            if (!paciente) {
                alert('Erro ao carregar dados do paciente');
                return;
            }

            currentPatientId = id;
            const contato = paciente.contatoEmergencial || {};
            const info = paciente.informacaoMedica || {};

            // Preencher formulário de edição
            document.getElementById('editName').value = paciente.nome || '';
            document.getElementById('editBirthdate').value = paciente.dataNascimento || '';
            document.getElementById('editGender').value = paciente.genero || '';
            document.getElementById('editPhone').value = paciente.telefone || '';
            document.getElementById('editRelationship').value = paciente.relacionamento || '';
            document.getElementById('editRoom').value = '';
            document.getElementById('editBloodType').value = info.tipoSangue || '';
            document.getElementById('editAllergies').value = ''; // Campo de alergias (não mapeado no backend)
            document.getElementById('editMedicalConditions').value = info.problemasEspecificos || '';
            document.getElementById('editEmergencyName').value = contato.nome || '';
            document.getElementById('editEmergencyPhone').value = contato.telefone || '';
            document.getElementById('editEmergencyEmail').value = contato.email || '';

            openModal('editModal');
        }

        // Função para excluir paciente
        async function deletePatient(id) {
            const paciente = patients.find(p => p.id === id);
            if (!paciente) {
                alert('Paciente não encontrado');
                return;
            }

            const confirmacao = confirm(
                `Tem certeza que deseja EXCLUIR PERMANENTEMENTE o paciente "${paciente.name}"?\n\n` +
                `Esta ação não pode ser desfeita e removerá todos os dados do paciente, incluindo:\n` +
                `- Informações pessoais e médicas\n` +
                `- Histórico de sinais vitais\n` +
                `- Alertas relacionados\n\n` +
                `Digite "CONFIRMAR" no próximo campo se deseja prosseguir.`
            );

            if (!confirmacao) {
                return;
            }

            const confirmacaoTexto = prompt(
                `Para confirmar a exclusão do paciente "${paciente.name}", digite: CONFIRMAR`
            );

            if (confirmacaoTexto !== 'CONFIRMAR') {
                alert('Exclusão cancelada. Texto de confirmação incorreto.');
                return;
            }

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/pacientes/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Paciente excluído com sucesso!');
                    await carregarPacientes();
                    renderPatients();
                    updateStats();
                } else {
                    alert('Erro ao excluir paciente. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor. Tente novamente.');
            }
        }

        // Função para salvar alterações do paciente
        document.getElementById('editPatientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentPatientId) {
                alert('Erro: ID do paciente não encontrado');
                return;
            }

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            const pacienteData = {
                nome: data.name.trim(),
                dataNascimento: data.birthdate,
                genero: data.gender,
                telefone: data.phone || null,
                relacionamento: data.relationship || null,
                contatoEmergencial: {
                    nome: data.emergencyName || null,
                    telefone: data.emergencyPhone || null,
                    email: data.emergencyEmail || null,
                    instagram: null
                },
                informacaoMedica: {
                    tipoSangue: data.bloodType || null,
                    deficiencia: data.allergies || null,
                    problemasEspecificos: data.medicalConditions || null
                },
                sinaisVitais: {
                    oxigenio: parseFloat(data.oxygen) || 98.0,
                    temperatura: parseFloat(data.temperature) || 36.5,
                    batimentos: parseInt(data.heartRate) || 72,
                    statusOxigenio: 'stable',
                    statusTemperatura: 'stable',
                    statusBatimentos: 'stable'
                }
            };

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/pacientes/${currentPatientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pacienteData)
                });

                if (response.ok) {
                    closeModal('editModal');
                    await carregarPacientes();
                    renderPatients();
                    updateStats();
                    alert('Paciente atualizado com sucesso!');
                } else {
                    alert('Erro ao atualizar paciente');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar paciente. Tente novamente.');
            }
        });

        // Atualizar estatísticas
        function updateStats() {
            const total = patients.length;
            const stable = patients.filter(p => p.status === 'normal').length;
            const warning = patients.filter(p => p.status === 'warning').length;
            const critical = patients.filter(p => p.status === 'critical').length;
            
            document.getElementById('totalPatients').textContent = total;
            document.getElementById('stablePatients').textContent = stable;
            document.getElementById('warningPatients').textContent = warning;
            document.getElementById('criticalPatients').textContent = critical;
        }

        // Inicializar página
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar pacientes do backend
            await carregarPacientes();
            renderPatients();
            updateStats();
            
            // Atualizar dados periodicamente
            setInterval(async () => {
                await carregarPacientes();
                renderPatients();
                updateStats();
            }, 30000); // Atualizar a cada 30 segundos
        });
    </script>

    <!-- Navbar Script -->
    <script src="../js/navbar.js"></script>
</body>
</html>