<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Usuário - Sistema de Monitoramento de Pacientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">Sistema Monitoramento</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pacientes.html">Pacientes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="usuarios.html">Usuários</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="configurar-alertas.html">Configurar Alertas</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Editar Usuário</h4>
                        <a href="usuarios.html" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="message" class="alert" style="display: none;"></div>
                        
                        <form id="editarUsuarioForm">
                            <input type="hidden" id="usuarioId" name="id">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nome" class="form-label">Nome Completo *</label>
                                        <input type="text" class="form-control" id="nome" name="nome" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">E-mail *</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="senha" class="form-label">Nova Senha (opcional)</label>
                                        <input type="password" class="form-control" id="senha" name="senha">
                                        <div class="form-text">Deixe em branco para manter a senha atual</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="confirmarSenha" class="form-label">Confirmar Nova Senha</label>
                                        <input type="password" class="form-control" id="confirmarSenha" name="confirmarSenha">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ativo" name="ativo" checked>
                                        <label class="form-check-label" for="ativo">
                                            Usuário ativo
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary" id="btnSalvar">
                                    <i class="bi bi-check-circle"></i> Salvar Alterações
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let usuarioId = null;

        // Carregar dados do usuário ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            usuarioId = urlParams.get('id');
            
            if (!usuarioId) {
                showMessage('ID do usuário não fornecido', 'danger');
                return;
            }
            
            carregarDadosUsuario(usuarioId);
        });

        // Função para carregar dados do usuário
        async function carregarDadosUsuario(id) {
            try {
                const usuario = await apiRequest(`/api/usuarios/${id}`, { method: 'GET' });
                if (usuario) {
                    preencherFormulario(usuario);
                } else {
                    showMessage('Erro ao carregar dados do usuário', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showMessage('Erro ao conectar com o servidor', 'danger');
            }
        }

        // Função para preencher formulário
        function preencherFormulario(usuario) {
            document.getElementById('usuarioId').value = usuario.id;
            document.getElementById('nome').value = usuario.nome;
            document.getElementById('email').value = usuario.email;
            document.getElementById('ativo').checked = usuario.ativo;
        }

        // Event listener para o formulário
        document.getElementById('editarUsuarioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const dados = {};
            
            // Validar senhas se preenchidas
            const senha = formData.get('senha');
            const confirmarSenha = formData.get('confirmarSenha');
            
            if (senha && senha !== confirmarSenha) {
                showMessage('As senhas não coincidem', 'danger');
                return;
            }
            
            // Preparar dados para envio
            if (formData.get('nome')) dados.nome = formData.get('nome');
            if (formData.get('email')) dados.email = formData.get('email');
            if (senha) dados.senha = senha;
            
            try {
                const btnSalvar = document.getElementById('btnSalvar');
                btnSalvar.disabled = true;
                btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Salvando...';
                
                const result = await apiRequest(`/api/usuarios/${usuarioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                if (result && result.success) {
                    showMessage('Usuário atualizado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.href = 'usuarios.html';
                    }, 2000);
                } else {
                    showMessage((result && result.message) || 'Erro ao atualizar usuário', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showMessage('Erro ao conectar com o servidor', 'danger');
            } finally {
                const btnSalvar = document.getElementById('btnSalvar');
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Alterações';
            }
        });

        // Função para mostrar mensagens
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Função de logout
        function logout() {
            localStorage.removeItem('usuario');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>